### Event Sourcing & CQRS ë°ëª¨ ìŠ¤í¬ë¦½íŠ¸
### IntelliJ HTTP Clientìš©
### í”„ë ˆì  í…Œì´ì…˜ ìˆœì„œëŒ€ë¡œ ì‹¤í–‰ (PRESENTATION.md ê¸°ì¤€)

###############################################
# ğŸ“¹ ë°ëª¨ 1: Event Sourcing (Step 2 ì™„ë£Œ í›„)
###############################################

### [ë°ëª¨1-1] í†µí™” ìš”ì²­ (REQUESTED)
# â†’ call_event_store ì €ì¥ (Event Store)
# â†’ CallView ìƒì„± (Read Model)
POST http://localhost:8090/api/calls/events/requested
Content-Type: application/json

{
  "sessionId": "call-001",
  "source": "customer-1",
  "destination": "2001"
}

### [ë°ëª¨1-2] í†µí™” ì—°ê²° (CONNECTED)
# â†’ call_event_store ì €ì¥
# â†’ CallView ì—…ë°ì´íŠ¸ (status = ACTIVE)
POST http://localhost:8090/api/calls/events/connected
Content-Type: application/json

{
  "sessionId": "call-001"
}

### [ë°ëª¨1-3] í†µí™” ì¢…ë£Œ (DISCONNECTED)
# â†’ call_event_store ì €ì¥
# â†’ CallView ì—…ë°ì´íŠ¸ (status = ENDED, duration ê³„ì‚°)
POST http://localhost:8090/api/calls/events/disconnected
Content-Type: application/json

{
  "sessionId": "call-001"
}

### [ë°ëª¨1-4] í™•ì¸ í¬ì¸íŠ¸ - Event Store (3ê°œ ì´ë²¤íŠ¸ ë³´ì¡´)
# H2 Consoleì—ì„œ ì‹¤í–‰:
# SELECT event_type, occurred_at FROM call_event_store
# WHERE session_id = 'call-001' ORDER BY occurred_at;

### [ë°ëª¨1-5] í™•ì¸ í¬ì¸íŠ¸ - Read Model (ìµœì¢… ìƒíƒœ)
GET http://localhost:8090/api/calls/call-001

### ğŸ’¡ í•µì‹¬: ì´ë ¥(Event Store) + ë¹ ë¥¸ ì¡°íšŒ(CallView) ë¶„ë¦¬

###############################################
# ğŸ“¹ ë°ëª¨ 2: CQRS + Event Sourcing (Step 4 ì™„ë£Œ í›„)
###############################################

### [ë°ëª¨2-1] Agent ìƒì„± (Alice)
# â†’ agent ì €ì¥ (Command Model)
# â†’ AgentView ìƒì„± (Query Model, status = UNAVAILABLE)
POST http://localhost:8090/api/agents
Content-Type: application/json

{
  "name": "Alice",
  "type": "HUMAN",
  "extensionNumber": "1001"
}

### ğŸ‘‰ Response: {"id": 1}

### [ë°ëª¨2-2] Extension Event - BUSY
# â†’ extension_event_store ì €ì¥ (Event Store)
# â†’ AgentView.status = BUSY
POST http://localhost:8090/api/agents/events/busy
Content-Type: application/json

{
  "extensionNumber": "1001",
  "sessionId": "call-001"
}

### [ë°ëª¨2-3] Extension Event - AVAILABLE
# â†’ extension_event_store ì €ì¥
# â†’ AgentView.status = AVAILABLE
POST http://localhost:8090/api/agents/events/available
Content-Type: application/json

{
  "extensionNumber": "1001",
  "sessionId": "call-001"
}

### [ë°ëª¨2-4] í™•ì¸ í¬ì¸íŠ¸ - Command Model (Agent ì •ë³´ë§Œ)
# H2 Consoleì—ì„œ ì‹¤í–‰:
# SELECT name, type, extension_number FROM agent WHERE id = 1;

### [ë°ëª¨2-5] í™•ì¸ í¬ì¸íŠ¸ - Event Store (Extension ì´ë ¥)
# H2 Consoleì—ì„œ ì‹¤í–‰:
# SELECT event_type, occurred_at FROM extension_event_store
# WHERE extension_number = '1001' ORDER BY occurred_at;

### [ë°ëª¨2-6] í™•ì¸ í¬ì¸íŠ¸ - Query Model (ìƒíƒœ í¬í•¨)
GET http://localhost:8090/api/agents/1

### ğŸ’¡ í•µì‹¬: Command/Query ë¶„ë¦¬ + Extension ì´ë²¤íŠ¸ ì†Œì‹±

###############################################
# ğŸ“¹ ë°ëª¨ 3: ë„ë©”ì¸ í†µí•© (Step 5 ì™„ë£Œ í›„)
###############################################

### [ë°ëª¨3-1] Agent ìƒì„± (Bob, extension: 2001)
POST http://localhost:8090/api/agents
Content-Type: application/json

{
  "name": "Bob",
  "type": "HUMAN",
  "extensionNumber": "2001"
}

### ğŸ‘‰ Response: {"id": 2}

### [ë°ëª¨3-2] Call ìš”ì²­ (call-002, destination: 2001)
POST http://localhost:8090/api/calls/events/requested
Content-Type: application/json

{
  "sessionId": "call-002",
  "source": "customer-2",
  "destination": "2001"
}

### [ë°ëª¨3-3] Extension Event (BUSY, session: call-002)
# â†’ extension_event_store ì €ì¥
# â†’ AgentView.status = BUSY
# â†’ CallParticipant ìƒì„± (agent: Bob, call: call-002, status: JOINED)
POST http://localhost:8090/api/agents/events/busy
Content-Type: application/json

{
  "extensionNumber": "2001",
  "sessionId": "call-002"
}

### [ë°ëª¨3-4] Call ì—°ê²°
# â†’ call_event_store ì €ì¥
# â†’ CallView.status = ACTIVE
POST http://localhost:8090/api/calls/events/connected
Content-Type: application/json

{
  "sessionId": "call-002"
}

### [ë°ëª¨3-5] Call ì¢…ë£Œ
# â†’ call_event_store ì €ì¥
# â†’ CallView.status = ENDED
POST http://localhost:8090/api/calls/events/disconnected
Content-Type: application/json

{
  "sessionId": "call-002"
}

### [ë°ëª¨3-6] Extension Event (AVAILABLE, session: call-002)
# â†’ extension_event_store ì €ì¥
# â†’ AgentView.status = AVAILABLE
# â†’ CallParticipant ì¢…ë£Œ (status: LEFT)
POST http://localhost:8090/api/agents/events/available
Content-Type: application/json

{
  "extensionNumber": "2001",
  "sessionId": "call-002"
}

### [ë°ëª¨3-7] í™•ì¸ í¬ì¸íŠ¸ - Agent â†’ Call ì¡°íšŒ
GET http://localhost:8090/api/participants/agent/2

### [ë°ëª¨3-8] í™•ì¸ í¬ì¸íŠ¸ - Call â†’ Agent ì¡°íšŒ
GET http://localhost:8090/api/participants/call/call-002

### [ë°ëª¨3-9] í™•ì¸ í¬ì¸íŠ¸ - SQLë¡œ ì–‘ë°©í–¥ ì¡°íšŒ
# H2 Consoleì—ì„œ ì‹¤í–‰:
# -- Agent â†’ Call ì¡°íšŒ
# SELECT cp.session_id, cp.joined_at, cv.status, cv.duration
# FROM call_participant cp
# JOIN call_view cv ON cp.session_id = cv.session_id
# WHERE cp.agent_id = 2;
#
# -- Call â†’ Agent ì¡°íšŒ
# SELECT cp.agent_id, av.name, cp.joined_at, cp.left_at
# FROM call_participant cp
# JOIN agent_view av ON cp.agent_id = av.agent_id
# WHERE cp.session_id = 'call-002';

### ğŸ’¡ í•µì‹¬: 3ê°œ ë„ë©”ì¸ì´ ì´ë²¤íŠ¸ë¡œë§Œ ì—°ê²° (ëŠìŠ¨í•œ ê²°í•©)

###############################################
# ğŸ” H2 Console í™•ì¸ (Event Replay ë°ëª¨)
###############################################

### ğŸ‘‰ H2 Console ì ‘ì†: http://localhost:8090/h2-console
###    JDBC URL: jdbc:h2:mem:demo-cqrs
###    Username: sa
###    Password: (ë¹„ì›Œë‘ê¸°)

### [H2-1] AgentView ì‚­ì œ (ì‹œë®¬ë ˆì´ì…˜)
/*
-- í˜„ì¬ ìƒíƒœ
SELECT COUNT(*) FROM agent_view;  -- 2ê°œ (Alice, Bob)

-- AgentView ì‚­ì œ
DELETE FROM agent_view;

-- Event StoreëŠ” ê·¸ëŒ€ë¡œ
SELECT COUNT(*) FROM extension_event_store;  -- ì´ë²¤íŠ¸ ë³´ì¡´ë¨
*/

### [H2-2] Event Replayë¡œ AgentView ì¬êµ¬ì¶•
/*
-- Extension Event Storeì—ì„œ ìˆœì„œëŒ€ë¡œ ì½ê¸°
SELECT event_type, extension_number, occurred_at
FROM extension_event_store
ORDER BY occurred_at;

-- (ì‹¤ì œ ì¬êµ¬ì¶•ì€ ì½”ë“œì—ì„œ ì´ë²¤íŠ¸ ë¦¬í”Œë ˆì´ ë¡œì§ í•„ìš”)
-- ë°ëª¨ì—ì„œëŠ” "Event Storeë§Œ ìˆìœ¼ë©´ ì¬êµ¬ì¶• ê°€ëŠ¥" ê°œë… ì„¤ëª…
*/

### [H2-3] 3ê°œ Event Store í™•ì¸
/*
-- Call Event Store
SELECT COUNT(*) FROM call_event_store;

-- Extension Event Store
SELECT COUNT(*) FROM extension_event_store;

-- ëª¨ë“  ì´ë²¤íŠ¸ ë³´ì¡´ â†’ ì‹œê°„ ì—¬í–‰ ê°€ëŠ¥
*/

###############################################
# ğŸ“‹ í”„ë ˆì  í…Œì´ì…˜ ì²´í¬ë¦¬ìŠ¤íŠ¸
###############################################

### âœ… ë°ëª¨ 1 (Step 2): Event Sourcing
###    - call_event_store 3ê°œ ì´ë²¤íŠ¸ ë³´ì¡´ í™•ì¸
###    - call_view ìµœì¢… ìƒíƒœ í™•ì¸
###    - ì´ë ¥ vs ì¡°íšŒ ë¶„ë¦¬ ì„¤ëª…

### âœ… ë°ëª¨ 2 (Step 4): CQRS + Event Sourcing
###    - agent (Command): status ì—†ìŒ
###    - extension_event_store: Extension ì´ë²¤íŠ¸ ì´ë ¥
###    - agent_view (Query): status í¬í•¨

### âœ… ë°ëª¨ 3 (Step 5): ë„ë©”ì¸ í†µí•©
###    - Extension Eventë¡œ 3ê°œ ë„ë©”ì¸ ì—°ê²°
###    - CallParticipant ìë™ ìƒì„±/ì¢…ë£Œ
###    - ì–‘ë°©í–¥ ì¡°íšŒ (Agent â†” Call)

### âœ… H2 Console: Event Replay
###    - AgentView ì‚­ì œ ì‹œë®¬ë ˆì´ì…˜
###    - Event Store ë³´ì¡´ í™•ì¸
###    - ì¬êµ¬ì¶• ê°€ëŠ¥ì„± ì„¤ëª…

###############################################
# ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ê°€ì´ë“œ
###############################################

### í„°ë¯¸ë„ì—ì„œ ì‹¤í–‰:
### ./gradlew test
### ./gradlew test --tests "demo.cqrs.call.CallEventSourcingTest"
### ./gradlew test --tests "demo.cqrs.agent.AgentCqrsTest"
### ./gradlew test --tests "demo.cqrs.participant.ParticipantIntegrationTest"

